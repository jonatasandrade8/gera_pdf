<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Recibos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .form-section { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-section h2 { color: #333; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .row.full { grid-template-columns: 1fr; }
        .type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .type-btn { padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; transition: all 0.3s; background: white; font-weight: 500; }
        .type-btn.active { border-color: #667eea; background: #667eea; color: white; }
        .services-list { background: #f5f5f5; border-radius: 6px; padding: 15px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
        .service-item { background: white; padding: 20px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .service-item:last-child { margin-bottom: 0; }
        .service-field { margin-bottom: 15px; }
        .service-field:last-child { margin-bottom: 0; }
        .service-field label { display: block; margin-bottom: 6px; color: #333; font-weight: 600; font-size: 13px; }
        .service-field input { width: 100%; }
        .service-row { display: grid; grid-template-columns: 1fr 1fr 1fr 50px; gap: 15px; align-items: flex-end; }
        .service-row .service-field { margin-bottom: 0; }
        .btn-remove-service { background: #ff6b6b; color: white; border: none; padding: 10px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; height: 42px; width: 100%; }
        .btn-remove-service:hover { background: #ff5252; }
        .btn-remove { background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; height: 42px; }
        .btn-remove:hover { background: #ff5252; }
        .btn { padding: 14px 28px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; width: 100%; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #48bb78; color: white; width: 100%; margin-top: 10px; }
        .btn-secondary:hover { background: #38a169; }
        .total-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; font-size: 18px; font-weight: 600; margin-top: 20px; }
        .total-amount { font-size: 32px; margin-top: 10px; }
        .document-preview { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 600px; overflow-y: auto; }
        .preview-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        .preview-title { font-size: 24px; font-weight: bold; }
        .preview-section { margin-bottom: 20px; }
        .preview-section h3 { background: #f5f5f5; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 12px; color: #666; border-left: 4px solid #667eea; }
        .preview-content { font-size: 13px; line-height: 1.6; }
        .preview-row { display: grid; grid-template-columns: 120px 1fr; margin-bottom: 5px; gap: 10px; }
        .preview-label { font-weight: 600; color: #333; }
        .preview-value { color: #666; }
        .services-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .services-table th { background: #f5f5f5; padding: 8px; text-align: left; border-bottom: 2px solid #667eea; font-weight: 600; }
        .services-table td { padding: 8px; border-bottom: 1px solid #e0e0e0; }
        .services-table tr:last-child td { border-bottom: 2px solid #667eea; }
        @media (max-width: 1024px) { .content { grid-template-columns: 1fr; } .document-preview { max-height: 500px; } .service-content { grid-template-columns: 1fr; } }
        .section-title { color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 16px; font-weight: 600; }
        .error { color: #ff6b6b; font-size: 12px; margin-top: 5px; }
        .success { color: #48bb78; font-size: 12px; margin-top: 5px; }

        /* Estilos para o CRUD */
        .saved-receipts-list { margin-top: 20px; max-height: 200px; overflow-y: auto; background: #f9f9f9; border-radius: 6px; padding: 10px; }
        .saved-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px; }
        .saved-item-name { font-weight: 500; }
        .saved-item-actions button { margin-left: 8px; padding: 6px 10px; font-size: 12px; }
        .btn-load { background: #667eea; color: white; border: none; }
        .btn-delete { background: #ff6b6b; color: white; border: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Gerador de Recibos</h1>
            <p>Crie recibos profissionais em PDF de forma r√°pida e segura</p>
        </div>

        <div class="content">
            <div class="form-section">
                <h2>Informa√ß√µes do Recibo</h2>

                <div class="section-title">üë§ Recebedor</div>
                
                <div class="type-selector">
                    <button class="type-btn active" onclick="setRecebedorType('pf')" id="btn-recebedor-pf">Pessoa F√≠sica</button>
                    <button class="type-btn" onclick="setRecebedorType('pj')" id="btn-recebedor-pj">Pessoa Jur√≠dica</button>
                </div>

                <div class="form-group">
                    <label id="label-recebedor-nome">Nome Completo *</label>
                    <input type="text" id="recebedor-nome" placeholder="Ex: Jo√£o da Silva" oninput="atualizarPrevia()">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label id="label-recebedor-doc">CPF *</label>
                        <input type="text" id="recebedor-doc" placeholder="000.000.000-00" maxlength="18" oninput="atualizarPrevia()" onblur="buscarCNPJ('recebedor')">
                    </div>
                    <div class="form-group">
                        <label>Telefone *</label>
                        <input type="tel" id="recebedor-tel" placeholder="(00) 00000-0000" maxlength="15" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="form-group">
                    <label>CEP *</label>
                    <input type="text" id="recebedor-cep" placeholder="00000-000" maxlength="9" onblur="buscarCEP('recebedor')">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Rua *</label>
                        <input type="text" id="recebedor-rua" placeholder="Endere√ßo" oninput="atualizarPrevia()">
                    </div>
                    <div class="form-group">
                        <label>N√∫mero *</label>
                        <input type="text" id="recebedor-num" placeholder="0000" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="row full">
                    <div class="form-group">
                        <label>Complemento</label>
                        <input type="text" id="recebedor-comp" placeholder="Apt, sala, etc" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Cidade *</label>
                        <input type="text" id="recebedor-cidade" placeholder="Cidade" oninput="atualizarPrevia()">
                    </div>
                    <div class="form-group">
                        <label>UF *</label>
                        <input type="text" id="recebedor-uf" placeholder="SP" maxlength="2" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="section-title">üí∞ Pagador</div>

                <div class="type-selector">
                    <button class="type-btn active" onclick="setPagadorType('pf')" id="btn-pagador-pf">Pessoa F√≠sica</button>
                    <button class="type-btn" onclick="setPagadorType('pj')" id="btn-pagador-pj">Pessoa Jur√≠dica</button>
                </div>

                <div class="form-group">
                    <label id="label-pagador-nome">Nome Completo</label>
                    <input type="text" id="pagador-nome" placeholder="Ex: Maria da Silva" oninput="atualizarPrevia()">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label id="label-pagador-doc">CPF</label>
                        <input type="text" id="pagador-doc" placeholder="000.000.000-00" maxlength="18" oninput="atualizarPrevia()" onblur="buscarCNPJ('pagador')">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="pagador-tel" placeholder="(00) 00000-0000" maxlength="15" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="form-group">
                    <label>CEP</label>
                    <input type="text" id="pagador-cep" placeholder="00000-000" maxlength="9" onblur="buscarCEP('pagador')">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Rua</label>
                        <input type="text" id="pagador-rua" placeholder="Endere√ßo" oninput="atualizarPrevia()">
                    </div>
                    <div class="form-group">
                        <label>N√∫mero</label>
                        <input type="text" id="pagador-num" placeholder="0000" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="row full">
                    <div class="form-group">
                        <label>Complemento</label>
                        <input type="text" id="pagador-comp" placeholder="Apt, sala, etc" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" id="pagador-cidade" placeholder="Cidade" oninput="atualizarPrevia()">
                    </div>
                    <div class="form-group">
                        <label>UF</label>
                        <input type="text" id="pagador-uf" placeholder="SP" maxlength="2" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="section-title">üõçÔ∏è Produtos/Servi√ßos</div>

                <div class="services-list" id="services-list">
                    <p style="color: #999; text-align: center; padding: 20px;">Nenhum produto/servi√ßo adicionado</p>
                </div>

                <button class="btn btn-primary" onclick="adicionarServico()">+ Adicionar Produto/Servi√ßo</button>

                <div class="section-title">üìÖ Data/Per√≠odo da Presta√ß√£o de Servi√ßo</div>

                <div class="row full">
                    <div class="form-group">
                        <label>Tipo de Per√≠odo *</label>
                        <select id="periodo-tipo" onchange="atualizarPrevia()">
                            <option value="dia">Por Dia(s)</option>
                            <option value="mes">Por M√™s(es)</option>
                            <option value="ano">Por Ano(s)</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label id="label-periodo-inicio">Data de In√≠cio *</label>
                        <input type="date" id="periodo-inicio" oninput="atualizarPrevia()">
                    </div>
                    <div class="form-group">
                        <label id="label-periodo-fim">Data de T√©rmino *</label>
                        <input type="date" id="periodo-fim" oninput="atualizarPrevia()">
                    </div>
                </div>

                <div class="total-box">
                    <div>Total do Recibo</div>
                    <div class="total-amount" id="total-amount">R$ 0,00</div>
                </div>

                <button class="btn btn-secondary" onclick="gerarPDF()">üì• Gerar PDF</button>

                <div class="section-title">üíæ Gerenciamento de Recibos</div>
                <button class="btn btn-primary" onclick="salvarRecibo()" style="background-color: #e67e22;">Salvar Recibo Atual</button>
                <div class="saved-receipts-list" id="lista-recibos-salvos">
                    <p style="color: #999; text-align: center; padding: 10px;">Nenhum recibo salvo.</p>
                </div>

            </div>

            <div class="form-section">
                <h2>Pr√©via do Recibo</h2>
                <div class="document-preview" id="preview"></div>
            </div>
        </div>
    </div>

    <script>
        let servicos = [];
        let recebedorType = 'pf';
        let pagadorType = 'pf';
        let recibosSalvos = [];

        // --- Fun√ß√µes de Gerenciamento de Tipo (PF/PJ) ---

        function setRecebedorType(type) {
            recebedorType = type;
            document.getElementById('btn-recebedor-pf').classList.toggle('active', type === 'pf');
            document.getElementById('btn-recebedor-pj').classList.toggle('active', type === 'pj');
            const labelNome = document.getElementById('label-recebedor-nome');
            const labelDoc = document.getElementById('label-recebedor-doc');
            const inputDoc = document.getElementById('recebedor-doc');
            
            if (type === 'pf') {
                labelNome.textContent = 'Nome Completo *';
                labelDoc.textContent = 'CPF *';
                inputDoc.placeholder = '000.000.000-00';
                inputDoc.maxLength = 14;
            } else {
                labelNome.textContent = 'Raz√£o Social *';
                labelDoc.textContent = 'CNPJ *';
                inputDoc.placeholder = '00.000.000/0000-00';
                inputDoc.maxLength = 18;
            }
            inputDoc.value = '';
            atualizarPrevia();
        }

        function setPagadorType(type) {
            pagadorType = type;
            document.getElementById('btn-pagador-pf').classList.toggle('active', type === 'pf');
            document.getElementById('btn-pagador-pj').classList.toggle('active', type === 'pj');
            const labelNome = document.getElementById('label-pagador-nome');
            const labelDoc = document.getElementById('label-pagador-doc');
            const inputDoc = document.getElementById('pagador-doc');

            if (type === 'pf') {
                labelNome.textContent = 'Nome Completo';
                labelDoc.textContent = 'CPF';
                inputDoc.placeholder = '000.000.000-00';
                inputDoc.maxLength = 14;
            } else {
                labelNome.textContent = 'Raz√£o Social';
                labelDoc.textContent = 'CNPJ';
                inputDoc.placeholder = '00.000.000/0000-00';
                inputDoc.maxLength = 18;
            }
            inputDoc.value = '';
            atualizarPrevia();
        }

        // --- Fun√ß√µes de Busca (API) ---

        function buscarCEP(tipo) {
            const cepInput = document.getElementById(tipo + '-cep');
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length !== 8) return;

            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById(tipo + '-rua').value = data.logradouro;
                        document.getElementById(tipo + '-cidade').value = data.localidade;
                        document.getElementById(tipo + '-uf').value = data.uf;
                        document.getElementById(tipo + '-num').focus(); // Foca no n√∫mero
                        atualizarPrevia();
                    } else {
                        alert('CEP n√£o encontrado!');
                        cepInput.value = '';
                    }
                })
                .catch(err => {
                    alert('Erro ao buscar CEP: ' + err);
                    console.error(err);
                });
        }

        // NOVA FUN√á√ÉO: Buscar CNPJ
        function buscarCNPJ(tipo) {
            const currentType = (tipo === 'recebedor') ? recebedorType : pagadorType;
            if (currentType !== 'pj') return; // S√≥ busca se for PJ

            const cnpjInput = document.getElementById(tipo + '-doc');
            const cnpj = cnpjInput.value.replace(/\D/g, '');
            if (cnpj.length !== 14) return;

            // Usando a API p√∫blica brasilapi.com.br (gratuita e sem CORS)
            fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`)
                .then(res => {
                    if (!res.ok) throw new Error('CNPJ n√£o encontrado ou API indispon√≠vel');
                    return res.json();
                })
                .then(data => {
                    document.getElementById(tipo + '-nome').value = data.razao_social || '';
                    document.getElementById(tipo + '-rua').value = data.logradouro || '';
                    document.getElementById(tipo + '-num').value = data.numero || '';
                    document.getElementById(tipo + '-comp').value = data.complemento || '';
                    document.getElementById(tipo + '-cep').value = data.cep || '';
                    document.getElementById(tipo + '-cidade').value = data.municipio || '';
                    document.getElementById(tipo + '-uf').value = data.uf || '';
                    document.getElementById(tipo + '-tel').value = data.ddd_telefone_1 || '';
                    
                    atualizarPrevia();
                })
                .catch(err => {
                    alert('Erro ao buscar CNPJ: ' + err.message);
                    console.error(err);
                });
        }


        // --- Fun√ß√µes de Gerenciamento de Servi√ßos (Item do Recibo) ---

        function adicionarServico() {
            const id = Date.now();
            servicos.push({ id, descricao: '', quantidade: 1, preco: 0 });
            renderizarServicos();
            atualizarPrevia(); // Garante que a pr√©via atualize mesmo com item vazio
        }

        function removerServico(id) {
            servicos = servicos.filter(s => s.id !== id);
            renderizarServicos();
            atualizarPrevia(); // Atualiza pr√©via e total
        }

        function atualizarServico(id, campo, valor) {
            const servico = servicos.find(s => s.id === id);
            if (servico) {
                if (campo === 'quantidade' || campo === 'preco') {
                    servico[campo] = parseFloat(valor) || 0;
                } else {
                    servico[campo] = valor;
                }
                atualizarPrevia(); // Atualiza pr√©via e total
            }
        }

        function renderizarServicos() {
            const lista = document.getElementById('services-list');
            if (servicos.length === 0) {
                lista.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhum produto/servi√ßo adicionado</p>';
                calcularTotal(); // Recalcula para zerar o total se o √∫ltimo item for removido
                return;
            }

            lista.innerHTML = servicos.map(s => `
                <div class="service-item">
                    <div class="service-field">
                        <label>Descri√ß√£o:</label>
                        <input type="text" placeholder="Ex: Consultoria, Desenvolvimento, Aluguel..." value="${s.descricao}" oninput="atualizarServico(${s.id}, 'descricao', this.value)">
                    </div>
                    <div class="service-row">
                        <div class="service-field">
                            <label>Quantidade:</label>
                            <input type="number" min="0" step="0.01" placeholder="1" value="${s.quantidade}" oninput="atualizarServico(${s.id}, 'quantidade', this.value)">
                        </div>
                        <div class="service-field">
                            <label>Pre√ßo UNIT:</label>
                            <input type="number" min="0" step="0.01" placeholder="0.00" value="${s.preco}" oninput="atualizarServico(${s.id}, 'preco', this.value)">
                        </div>
                        <div class="service-field">
                            <label>&nbsp;</label>
                            <button class="btn-remove-service" onclick="removerServico(${s.id})">‚úï Remover</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            calcularTotal(); // Atualiza o total sempre que renderiza
        }

        // --- Fun√ß√µes de C√°lculo e Formata√ß√£o ---

        function calcularTotal() {
            const total = servicos.reduce((sum, s) => sum + (s.quantidade * s.preco), 0);
            document.getElementById('total-amount').textContent = formatarMoeda(total);
            return total;
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
        }

        // --- Fun√ß√µes de Atualiza√ß√£o da UI (Preview) ---

        function atualizarPrevia() {
            const total = calcularTotal();

            const recebedorEnd = [
                document.getElementById('recebedor-rua').value,
                document.getElementById('recebedor-num').value,
                document.getElementById('recebedor-comp').value,
                document.getElementById('recebedor-cidade').value,
                document.getElementById('recebedor-uf').value
            ].filter(Boolean).join(', ');

            const pagadorEnd = [
                document.getElementById('pagador-rua').value,
                document.getElementById('pagador-num').value,
                document.getElementById('pagador-comp').value,
                document.getElementById('pagador-cidade').value,
                document.getElementById('pagador-uf').value
            ].filter(Boolean).join(', ');

            let html = `
                <div class="preview-header">
                    <div class="preview-title">RECIBO</div>
                </div>

                <div class="preview-section">
                    <h3>RECEBEDOR</h3>
                    <div class="preview-content">
                        <div class="preview-row">
                            <div class="preview-label">Nome:</div>
                            <div class="preview-value">${document.getElementById('recebedor-nome').value || '‚Äî'}</div>
                        </div>
                        <div class="preview-row">
                            <div class="preview-label">${recebedorType === 'pf' ? 'CPF' : 'CNPJ'}:</div>
                            <div class="preview-value">${document.getElementById('recebedor-doc').value || '‚Äî'}</div>
                        </div>
                        <div class="preview-row">
                            <div class="preview-label">Tel:</div>
                            <div class="preview-value">${document.getElementById('recebedor-tel').value || '‚Äî'}</div>
                        </div>
                        ${recebedorEnd ? `<div class="preview-row"><div class="preview-label">End:</div><div class="preview-value">${recebedorEnd}</div></div>` : ''}
                    </div>
                </div>

                <div class="preview-section">
                    <h3>PAGADOR</h3>
                    <div class="preview-content">
                        <div class="preview-row">
                            <div class="preview-label">Nome:</div>
                            <div class="preview-value">${document.getElementById('pagador-nome').value || '‚Äî'}</div>
                        </div>
                        ${document.getElementById('pagador-doc').value ? `
                            <div class="preview-row">
                                <div class="preview-label">${pagadorType === 'pf' ? 'CPF' : 'CNPJ'}:</div>
                                <div class="preview-value">${document.getElementById('pagador-doc').value}</div>
                            </div>
                        ` : ''}
                        ${document.getElementById('pagador-tel').value ? `
                            <div class="preview-row">
                                <div class="preview-label">Tel:</div>
                                <div class="preview-value">${document.getElementById('pagador-tel').value}</div>
                            </div>
                        ` : ''}
                        ${pagadorEnd ? `<div class="preview-row"><div class="preview-label">End:</div><div class="preview-value">${pagadorEnd}</div></div>` : ''}
                    </div>
                </div>

                ${servicos.length > 0 ? `
                    <div class="preview-section">
                        <h3>PRODUTOS/SERVI√áOS</h3>
                        <table class="services-table">
                            <thead>
                                <tr>
                                    <th>Descri√ß√£o</th>
                                    <th style="text-align: center; width: 50px;">Qtd</th>
                                    <th style="text-align: right; width: 80px;">Pre√ßo Unit.</th>
                                    <th style="text-align: right; width: 80px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${servicos.map(s => `
                                    <tr>
                                        <td>${s.descricao || 'N/D'}</td>
                                        <td style="text-align: center;">${s.quantidade}</td>
                                        <td style="text-align: right;">${formatarMoeda(s.preco)}</td>
                                        <td style="text-align: right;">${formatarMoeda(s.quantidade * s.preco)}</td>
                                    </tr>
                                `).join('')}
                                <tr style="background: #f5f5f5;">
                                    <td style="font-weight: bold;" colspan="3">TOTAL</td>
                                    <td style="text-align: right; font-weight: bold;">${formatarMoeda(total)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            `;

            document.getElementById('preview').innerHTML = html;
        }

        // --- Fun√ß√µes de Valida√ß√£o e Gera√ß√£o de PDF ---

        function validarFormulario() {
            // Campos obrigat√≥rios do Recebedor
            const camposRecebedor = [
                'recebedor-nome', 'recebedor-doc', 'recebedor-tel', 'recebedor-cep',
                'recebedor-rua', 'recebedor-num', 'recebedor-cidade', 'recebedor-uf'
            ];

            for (let campo of camposRecebedor) {
                const el = document.getElementById(campo);
                if (!el.value.trim()) {
                    alert(`O campo "${el.previousElementSibling.textContent}" do RECEBEDOR √© obrigat√≥rio.`);
                    el.focus();
                    return false;
                }
            }
            
            // Campos obrigat√≥rios do Per√≠odo
            const camposPeriodo = ['periodo-inicio', 'periodo-fim'];
             for (let campo of camposPeriodo) {
                const el = document.getElementById(campo);
                if (!el.value) {
                    alert(`O campo "${el.previousElementSibling.textContent}" √© obrigat√≥rio.`);
                    el.focus();
                    return false;
                }
            }
            
            // Valida√ß√£o de Data
            const inicio = new Date(document.getElementById('periodo-inicio').value);
            const fim = new Date(document.getElementById('periodo-fim').value);
            if (fim < inicio) {
                alert('A data de t√©rmino n√£o pode ser anterior √† data de in√≠cio.');
                return false;
            }

            // Valida√ß√£o dos Servi√ßos
            if (servicos.length === 0) {
                alert('Adicione pelo menos um produto ou servi√ßo.');
                return false;
            }

            for (let i = 0; i < servicos.length; i++) {
                const s = servicos[i];
                if (!s.descricao.trim() || s.quantidade <= 0 || s.preco <= 0) {
                    alert(`O servi√ßo #${i + 1} est√° incompleto. Todos os servi√ßos devem ter descri√ß√£o, quantidade > 0 e pre√ßo > 0.`);
                    return false;
                }
            }

            return true;
        }

        // FUN√á√ÉO CORRIGIDA: Gerar PDF
        function gerarPDF() {
            if (!validarFormulario()) return;

            const total = calcularTotal(); // Pega o valor j√° formatado
            const totalBruto = servicos.reduce((sum, s) => sum + (s.quantidade * s.preco), 0);

            const recebedorEnd = [
                document.getElementById('recebedor-rua').value,
                document.getElementById('recebedor-num').value,
                document.getElementById('recebedor-comp').value,
            ].filter(Boolean).join(', ') + (document.getElementById('recebedor-comp').value ? ' - ' : '') + 
            [
                document.getElementById('recebedor-cidade').value,
                document.getElementById('recebedor-uf').value
            ].filter(Boolean).join(' / ');

            const pagadorEnd = [
                document.getElementById('pagador-rua').value,
                document.getElementById('pagador-num').value,
                document.getElementById('pagador-comp').value,
            ].filter(Boolean).join(', ') + (document.getElementById('pagador-comp').value ? ' - ' : '') + 
            [
                document.getElementById('pagador-cidade').value,
                document.getElementById('pagador-uf').value
            ].filter(Boolean).join(' / ');

            const hoje = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            
            const periodoTipo = document.getElementById('periodo-tipo').options[document.getElementById('periodo-tipo').selectedIndex].text;
            
            // Formata datas corretamente (o input 'date' usa fuso UTC, precisamos corrigir)
            const dataInicioInput = document.getElementById('periodo-inicio').value;
            const dataFimInput = document.getElementById('periodo-fim').value;
            
            const periodoInicio = new Date(dataInicioInput + 'T03:00:00').toLocaleDateString('pt-BR');
            const periodoFim = new Date(dataFimInput + 'T03:00:00').toLocaleDateString('pt-BR');
            
            let textoPeriodicidade = `${periodoTipo} de ${periodoInicio} a ${periodoFim}`;


            // CORRE√á√ÉO: O HTML do PDF estava com estrutura inv√°lida.
            const html = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: Arial, sans-serif; 
                            color: #333; 
                            line-height: 1.5;
                        }
                        .pdf-container { 
                            width: 100%; 
                            max-width: 800px;
                            margin: 0 auto; 
                            padding: 40px;
                        }
                        .header { 
                            text-align: center; 
                            border-bottom: 2px solid #333; 
                            padding-bottom: 20px; 
                            margin-bottom: 30px; 
                        }
                        .header h1 { 
                            margin: 0; 
                            font-size: 28px; 
                            letter-spacing: 1px;
                        }
                        .section { 
                            margin-bottom: 25px; 
                        }
                        .section h2 { 
                            background: #f4f4f4; 
                            padding: 8px 12px; 
                            margin-bottom: 15px; 
                            font-size: 14px; 
                            border-left: 4px solid #667eea;
                            font-weight: bold;
                            text-transform: uppercase;
                        }
                        .info-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            font-size: 13px; 
                        }
                        .info-table td { 
                            padding: 6px 0; 
                            vertical-align: top;
                        }
                        .info-table td:first-child { 
                            width: 130px; 
                            font-weight: bold;
                            color: #555;
                        }
                        .services-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            font-size: 12px;
                            margin-top: 10px;
                        }
                        .services-table th { 
                            background: #f4f4f4; 
                            padding: 10px; 
                            text-align: left; 
                            border-bottom: 2px solid #667eea; 
                            font-weight: bold; 
                        }
                        .services-table td { 
                            padding: 10px; 
                            border-bottom: 1px solid #ddd;
                        }
                        .services-table .total-row td { 
                            border-top: 2px solid #667eea; 
                            border-bottom: 2px solid #667eea; 
                            font-weight: bold;
                            font-size: 14px;
                            background: #f9f9f9;
                        }
                        .text-right { text-align: right; }
                        .text-center { text-align: center; }
                        
                        .signatures { 
                            margin-top: 50px; 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 50px;
                        }
                        .signature-box { 
                            text-align: center;
                            padding-top: 20px;
                        }
                        .signature-line { 
                            border-top: 1px solid #333; 
                            margin-bottom: 8px;
                        }
                        .signature-name { 
                            font-weight: bold;
                            font-size: 13px;
                            margin-bottom: 3px;
                        }
                        .signature-label { 
                            font-size: 11px; 
                            color: #666;
                        }
                        .date-section { 
                            margin-top: 40px; 
                            text-align: center; 
                            font-size: 12px;
                            color: #555;
                        }
                    </style>
                </head>
                <body>
                    <div class="pdf-container">
                        <div class="header">
                            <h1>RECIBO</h1>
                        </div>

                        <div class="section">
                            <h2>RECEBEDOR (PRESTADOR)</h2>
                            <table class="info-table">
                                <tr>
                                    <td>Nome/Raz√£o:</td>
                                    <td>${document.getElementById('recebedor-nome').value}</td>
                                </tr>
                                <tr>
                                    <td>${recebedorType === 'pf' ? 'CPF' : 'CNPJ'}:</td>
                                    <td>${document.getElementById('recebedor-doc').value}</td>
                                </tr>
                                <tr>
                                    <td>Telefone:</td>
                                    <td>${document.getElementById('recebedor-tel').value}</td>
                                </tr>
                                <tr>
                                    <td>Endere√ßo:</td>
                                    <td>${recebedorEnd}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="section">
                            <h2>PAGADOR (CLIENTE)</h2>
                            <table class="info-table">
                                <tr>
                                    <td>Nome/Raz√£o:</td>
                                    <td>${document.getElementById('pagador-nome').value || '‚Äî'}</td>
                                </tr>
                                ${document.getElementById('pagador-doc').value ? `
                                    <tr>
                                        <td>${pagadorType === 'pf' ? 'CPF' : 'CNPJ'}:</td>
                                        <td>${document.getElementById('pagador-doc').value}</td>
                                    </tr>
                                ` : ''}
                                ${document.getElementById('pagador-tel').value ? `
                                    <tr>
                                        <td>Telefone:</td>
                                        <td>${document.getElementById('pagador-tel').value}</td>
                                    </tr>
                                ` : ''}
                                ${pagadorEnd ? `
                                    <tr>
                                        <td>Endere√ßo:</td>
                                        <td>${pagadorEnd}</td>
                                    </tr>
                                ` : ''}
                            </table>
                        </div>

                        <div class="section">
                            <h2>DESCRI√á√ÉO DOS SERVI√áOS/PRODUTOS</h2>
                            <table class="services-table">
                                <thead>
                                    <tr>
                                        <th>Descri√ß√£o</th>
                                        <th style="width: 60px;" class="text-center">Qtd.</th>
                                        <th style="width: 100px;" class="text-right">Pre√ßo Unit.</th>
                                        <th style="width: 100px;" class="text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${servicos.map(s => `
                                        <tr>
                                            <td>${s.descricao}</td>
                                            <td class="text-center">${s.quantidade}</td>
                                            <td class="text-right">${formatarMoeda(s.preco)}</td>
                                            <td class="text-right">${formatarMoeda(s.quantidade * s.preco)}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="total-row">
                                        <td colspan="3" class="text-right">TOTAL GERAL</td>
                                        <td class="text-right">${formatarMoeda(totalBruto)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="section">
                            <h2>PER√çODO DE PRESTA√á√ÉO</h2>
                            <table class="info-table">
                                <tr>
                                    <td style="width: 130px;">Referente a:</td>
                                    <td>${textoPeriodicidade}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="signatures">
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <div class="signature-name">${document.getElementById('recebedor-nome').value}</div>
                                <div class="signature-label">Assinatura do Recebedor</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <div class="signature-name">${document.getElementById('pagador-nome').value || 'PAGADOR'}</div>
                                <div class="signature-label">Assinatura do Pagador</div>
                            </div>
                        </div>

                        <div class="date-section">
                            Emitido em: ${hoje}
                        </div>
                    </div>
                </body>
                </html>
            `;

            const opt = {
                margin: [10, 10, 10, 10], // top, left, bottom, right
                filename: `recibo_${document.getElementById('recebedor-nome').value.replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // html2pdf().set(opt).from(html).save();
            // CORRE√á√ÉO: Usar o elemento previne bugs de renderiza√ß√£o de fontes e estilos
            const element = document.createElement('div');
            element.innerHTML = html;
            // √â preciso adicionar ao DOM temporariamente para renderizar
            document.body.appendChild(element); 
            
            html2pdf().from(element.firstElementChild).set(opt).save().then(() => {
                 document.body.removeChild(element); // Limpa o elemento do DOM
            });
        }

        // --- NOVAS FUN√á√ïES: CRUD (Salvar, Carregar, Remover) ---

        // Helper para obter todos os dados do formul√°rio
        function getFormData() {
            const data = {
                recebedorType,
                pagadorType,
                servicos: [...servicos] // Clona o array de servi√ßos
            };
            
            // Pega todos os inputs e selects
            const fields = document.querySelectorAll('.form-section input, .form-section select');
            fields.forEach(field => {
                if (field.id) {
                    data[field.id] = field.value;
                }
            });
            return data;
        }

        // Helper para popular o formul√°rio com dados salvos
        function populateForm(data) {
            // Seta os tipos (PF/PJ)
            setRecebedorType(data.recebedorType || 'pf');
            setPagadorType(data.pagadorType || 'pf');

            // Popula todos os inputs e selects
            const fields = document.querySelectorAll('.form-section input, .form-section select');
            fields.forEach(field => {
                if (field.id && data[field.id] !== undefined) {
                    field.value = data[field.id];
                }
            });

            // Popula os servi√ßos
            servicos = data.servicos ? [...data.servicos] : [];
            
            // Atualiza a UI
            renderizarServicos();
            atualizarPrevia();
        }

        function salvarRecibo() {
            let nome = prompt('Digite um nome para este modelo de recibo (Ex: Cliente X Mensal):');
            if (!nome || !nome.trim()) {
                alert('Nome inv√°lido. O recibo n√£o foi salvo.');
                return;
            }
            
            const data = getFormData();
            data.id = Date.now();
            data.nome = nome.trim();

            // Adiciona ou atualiza se j√° existir um com mesmo nome
            const existingIndex = recibosSalvos.findIndex(r => r.nome.toLowerCase() === data.nome.toLowerCase());
            if (existingIndex > -1) {
                if (!confirm('J√° existe um recibo com esse nome. Deseja sobrescrev√™-lo?')) {
                    return;
                }
                data.id = recibosSalvos[existingIndex].id; // Mant√©m o ID original
                recibosSalvos[existingIndex] = data;
            } else {
                 recibosSalvos.push(data);
            }

            localStorage.setItem('recibosGerador', JSON.stringify(recibosSalvos));
            renderRecibosSalvos();
            alert('Recibo salvo com sucesso!');
        }

        function carregarRecibo(id) {
            const recibo = recibosSalvos.find(r => r.id === id);
            if (recibo) {
                if (!confirm(`Deseja carregar o recibo "${recibo.nome}"? Suas altera√ß√µes atuais ser√£o perdidas.`)) {
                    return;
                }
                populateForm(recibo);
            }
        }

        function removerRecibo(id) {
            const recibo = recibosSalvos.find(r => r.id === id);
            if (recibo && confirm(`Tem certeza que deseja excluir o recibo salvo "${recibo.nome}"?`)) {
                recibosSalvos = recibosSalvos.filter(r => r.id !== id);
                localStorage.setItem('recibosGerador', JSON.stringify(recibosSalvos));
                renderRecibosSalvos();
            }
        }

        function renderRecibosSalvos() {
            const listaDiv = document.getElementById('lista-recibos-salvos');
            if (recibosSalvos.length === 0) {
                listaDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 10px;">Nenhum recibo salvo.</p>';
                return;
            }

            listaDiv.innerHTML = recibosSalvos.map(r => `
                <div class="saved-item">
                    <span class="saved-item-name">${r.nome}</span>
                    <div class="saved-item-actions">
                        <button class="btn btn-load" onclick="carregarRecibo(${r.id})">Carregar</button>
                        <button class="btn btn-delete" onclick="removerRecibo(${r.id})">Remover</button>
                    </div>
                </div>
            `).join('');
        }

        // --- Inicializa√ß√£o ---
        function init() {
            const salvos = localStorage.getItem('recibosGerador');
            if (salvos) {
                recibosSalvos = JSON.parse(salvos);
            }
            renderRecibosSalvos();
            renderizarServicos();
            atualizarPrevia();
        }

        // Inicializar a aplica√ß√£o
        init();
        
    </script>
</body>
</html>
